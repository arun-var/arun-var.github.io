<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Understanding docker layers and overlay filesystem</title>
  <meta name="description" content="What are docker layers and overlay filesystemsThis was one of the things that I wanted to understand better - What exactly is an overlay file system and how is docker using it.From archlinux wiki d..." />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@mushyinks" />
    <meta name="twitter:title" content="Understanding docker layers and overlay filesystem" />
    <meta name="twitter:image" content="http://0.0.0.0:4000/assets/images/av.svg" />
    
    <meta name="twitter:description"  content="What are docker layers and overlay filesystemsThis was one of the things that I wanted to understand better - What exactly is an overlay file system and how is docker using it.From archlinux wiki d..." />
    
  
  
  <meta property="og:site_name" content="Mushycode" />
  <meta property="og:title" content="Understanding docker layers and overlay filesystem"/>
  
  <meta property="og:description" content="What are docker layers and overlay filesystemsThis was one of the things that I wanted to understand better - What exactly is an overlay file system and how is docker using it.From archlinux wiki d..." />
  
  <meta property="og:image" content="http://0.0.0.0:4000/assets/article_images/2019-11-19-docker-layers-and-overlay-fs/docker1.jpg" />
  <meta property="og:url" content="http://0.0.0.0:4000/docker/2019/11/19/docker-layers-and-overlay-fs.html" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2019-11-19T12:47:46+00:00">

  <link rel="canonical" href="http://0.0.0.0:4000/docker/2019/11/19/docker-layers-and-overlay-fs.html"/>
  <link rel="shortcut icon" href="/assets/images/av.svg" type="image/png"/>
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->


  <a href="http://0.0.0.0:4000" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/av.svg)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="article-image">
          <div class="post-image-image" style="background-image: url(/assets/article_images/2019-11-19-docker-layers-and-overlay-fs/docker1.jpg)">
            Article Image
          </div>
          <div class="post-image-image2" style="background-image: url()">
            Article Image
          </div>
          <div class="post-meta">
            <h1 class="post-title">Understanding docker layers and overlay filesystem</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Arun Varghese</h4>
              on
              <time datetime="2019-11-19 12:47">19 Nov 2019</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
            <div style="text-align:center">
              <a href="#topofpage" class="topofpage"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </div>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <h2 id="what-are-docker-layers-and-overlay-filesystems">What are docker layers and overlay filesystems</h2>
<p>This was one of the things that I wanted to understand better - What exactly is an overlay file system and how is docker using it.
From archlinux wiki definition
“Overlayfs allows one, usually read-write, directory tree to be overlaid onto another, read-only directory tree. All modifications go to the upper, writable layer.”</p>

<p>An apt example is a linux live CD.</p>

<p>Lets get down to how this overlay file system works</p>

<h3 id="overlays-and-docker">Overlays and docker</h3>

<p>It consists of three layers for the sake of simplicity.</p>

<ul>
  <li>Lower Read Only Layer</li>
  <li>Upper Layer that allows read and write</li>
  <li>The Overlay layer itself that gives the user entire view of the filesystem and from where user actually reads a file or writes to them.</li>
</ul>

<h4 id="lower-layer">Lower Layer</h4>
<p>The read only layer where base files of the filesystem are stored. It can be visualized as the base image of our docker image or root of a live CD example.</p>

<h4 id="upper-layer">Upper Layer</h4>
<p>Any changes made in the overlay layer gets stored in the upper layer. Whenever a process reads a file from the overlay layer, it is checked in upper layer first, if not available it is read from the lower layer.</p>

<h4 id="overlay">Overlay</h4>
<p>This is the consolidated or union view of lower and upper layers and where the user works on. Whenever any changes are made to a file, overlay layer presents the union of upper and lower layers such that files in upper layer supersede the ones in lower layer.</p>

<p>When objects with the same name exist in both directory trees of upper and lower layers, then their treatment depends on the object type:</p>

<p>File: We see the file in the upper layer, and the file in the lower layer is hidden.</p>

<p>Directory: content of both upper and lower layers of the directory tree is combined and shown in the overlay</p>

<h4 id="copy-on-write">Copy-on-Write</h4>
<p>Whenever a file already present in lower layer is modified, the file is first copied over to the upper layer and then the modifications are made here.</p>

<h4 id="overlay-in-action">Overlay in action</h4>

<p>Lets create directories</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">root@dd4a4d50aefc:~# <span class="nb">mkdir </span>lower upper merged workdir
root@dd4a4d50aefc:~# <span class="nb">echo</span> <span class="s2">"I am in lower layer"</span> <span class="o">&gt;</span> lower/lower.txt
root@dd4a4d50aefc:~# <span class="nb">echo</span> <span class="s2">"I am in upper layer"</span> <span class="o">&gt;</span> upper/upper.txt
root@dd4a4d50aefc:~# <span class="nb">echo</span> <span class="s2">"I am common file lower layer"</span> <span class="o">&gt;</span> lower/common.txt
root@dd4a4d50aefc:~# <span class="nb">echo</span> <span class="s2">"I am common file upper layer"</span> <span class="o">&gt;</span> upper/common.txt
root@dd4a4d50aefc:~# <span class="nb">sudo </span>mount <span class="nt">-t</span> overlay overlay <span class="nt">-o</span> <span class="nv">lowerdir</span><span class="o">=</span>/root/lower,upperdir<span class="o">=</span>/root/upper,workdir<span class="o">=</span>/root/workdir /root/merged
root@dd4a4d50aefc:~# <span class="nb">ls </span>merged/
common.txt  lower.txt  upper.txt
root@dd4a4d50aefc:~# <span class="nb">cat </span>merged/common.txt 
I am common file upper layer
root@dd4a4d50aefc:~# <span class="nb">ls </span>lower/
common.txt  lower.txt
root@dd4a4d50aefc:~# <span class="nb">ls </span>upper/
common.txt  upper.txt</code></pre></figure>

<p>The lower layer can be read-only and an overlay itself, while the upper layer is normally writeable. In order to create an overlay of two directories, dir1 and dir2, we can use the following mount command:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">root@dd4a4d50aefc:~# <span class="nb">sudo </span>mount <span class="nt">-t</span> overlay overlay <span class="nt">-o</span> <span class="nv">lowerdir</span><span class="o">=</span>/root/lower2:/root/lower1,upperdir<span class="o">=</span>/root/upper,workdir<span class="o">=</span>/root/workdir /root/merged</code></pre></figure>

<p>while specifying multiple lower layers, they are separated by a :, with the rightmost lower directory on the bottom, and the leftmost lower directory on the top of the overlay.</p>

<h4 id="new-file-creation-in-overlay">New file creation in overlay</h4>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">root@dd4a4d50aefc:~# <span class="nb">echo</span> <span class="s2">"I am the new file on the block"</span> <span class="o">&gt;</span> merged/new.txt
root@dd4a4d50aefc:~# <span class="nb">ls </span>merged/
common.txt  lower.txt  new.txt  upper.txt
root@dd4a4d50aefc:~# <span class="nb">ls </span>upper/
common.txt  new.txt  upper.txt
root@dd4a4d50aefc:~# <span class="nb">ls </span>lower/
common.txt  lower.txt</code></pre></figure>

<p>References</p>
<ul>
  <li>https://docs.docker.com/storage/storagedriver/#images-and-layers</li>
  <li>https://wiki.archlinux.org/index.php/Overlay_filesystem</li>
  <li>https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt</li>
</ul>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Understanding+docker+layers+and+overlay+filesystem&amp;url=http://0.0.0.0:4000/docker/2019/11/19/docker-layers-and-overlay-fs"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Arun Varghese</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2019-11-19 12:47">19 Nov 2019</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Arun Varghese</a> &copy; 2022<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'mushycode'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/idea-2924175.png)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Mushycode</h1>
        <h2 class="blog-description">My thoughtsdump and playground
</h2>
        <a href=/ class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<!-- Google Analytics -->
<script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-150479150-Y', 'auto');
ga('send', 'pageview');

</script>



  </body>
</html>
